import zarrdataset as zds

from torch.utils.data import DataLoader
import numpy as np
import matplotlib.pyplot as plt


if __name__ == "__main__":

    # These are images from the Image Data Resource (IDR) 
    # https://idr.openmicroscopy.org/ that are publicly available and were 
    # converted to the OME-NGFF (Zarr) format by the OME group. More examples
    # can be found at Public OME-Zarr data (Nov. 2020)
    # https://www.openmicroscopy.org/2020/11/04/zarr-data.html

    filenames = [
        "https://uk1s3.embassy.ebi.ac.uk/idr/zarr/v0.4/idr0073A/9798462.zarr",
        "https://uk1s3.embassy.ebi.ac.uk/idr/zarr/v0.4/idr0073A/9798462.zarr"
        ]

    patch_size = dict(Y=256, X=256)
    patch_sampler = zds.BlueNoisePatchSampler(patch_size=patch_size)

    my_dataset = zds.ZarrDataset(filenames,
                                data_group="0",
                                source_axes="TCZYX",
                                patch_sampler=patch_sampler,
                                shuffle=True,
                                return_any_label=False)
    
    my_dataloader = DataLoader(my_dataset, num_workers=4,
                               worker_init_fn=zds.zarrdataset_worker_init)

    samples = []
    for i, sample in enumerate(my_dataloader):
        # Samples generated by DataLoaders have Batch (B) as first axes
        samples.append(np.moveaxis(sample[0, 0, :, 0].numpy(), 0, -1))

        print(f"Sample {i+1} with size {sample.shape}")

        if i > 5:
            # Take only five samples for illustration purposes
            break

    samples = np.hstack(samples)

    plt.imshow(samples)
    plt.show()
